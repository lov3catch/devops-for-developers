# Service Discovery

## Цель

На своем опыте познакомиться с Consul. В данной практике мы описали небольшую инфраструктуру из нескольких серверов. Представим, что эти сервера периодически добавляются в инфраструктуру и убираются из нее (например, для обновления), а перед нами стоит задача понять, какие из серверов доступны. Допустим, у нас есть приложение, которое делает некие вычисления на этих серверах. Для того чтобы сделать эти вычисления, нужно знать ip адрес сервера и убедиться, что он готов к нужной нам работе (например, на нем запущен docker или любая другая программа необходимая для вычислений). Эта задача может быть решена следующими способами:
1. После добавления очередного сервера, копируем его ip адрес в конфиг нашего приложения и перезапускаем его. При удалении сервера делаем все то же самое. Минусы - ручные операции, перезагрузка приложения и тд.
2. Устанавливаем consul и настраиваем service discovery. На каждом сервере устанавливается consul agent, который подключается к другим агентам в известной ему сети. После этого, он начинает передавать всю известную ему информацию остальным агентам в сети. Таким образом происходит быстрый обмен информацией, а при остановке сервера или появлении нового, другие агенты об этом узнают практически мгновенно. Когда мы хотим узнать ip адреса доступных серверов в нашей сети, мы делаем http запрос в Consul агент (О котором мы знаем. Например, в локальный агент.) и получаем список живых серверов вместе с ip адресами. Минусы такого подхода тоже есть. Самый значимый для нас на этом этапе - сложность настройки и обилие новых концепций.

В этой практике сервера и консул агенты на них практически полностью настроены за вас. Ваша задача заключается в том, чтобы установить инфраструктуру и увидеть, как это все работает. В практике нет сложного сервиса, которому требуется знать ip адреса других серверов в сети. Вместо этого вы являетесь этим сервисом, а тестирование происходит через утилиту curl. Поэтому успехом будет считаться получение списка серверов после выполнения всех действий, а так же обзор инфраструктуры и понимание роли consul в ней.

## Ссылки

* [Документация Consul](https://learn.hashicorp.com/consul)
* [Ansible — ipaddr filter](https://docs.ansible.com/ansible/latest/user_guide/playbooks_filters_ipaddr.html)
* [Consul with Containers](https://learn.hashicorp.com/tutorials/consul/docker-container-agents?in=consul/docker)

## Задачи

* Создайте (или используйте уже созданный) ssh ключ в DigitalOcean. Опишите создание в *terraform/ssh.tf*. В файле *terraform/servers.tf* опишите его использование.
* Выполните инициализацию Terraform в директории *terraform*. В этой директории описаны команды для создания инфраструктуры. Для работы с Digital Ocean экспортируйте переменную DO_PAT:

  ```sh
    export DO_PAT=<digital_ocean_token>
  ```

  Примените изменения в инфраструктуре, выполнив команду `make apply`. У вас автоматически создадутся сервера в вашем аккаунте DigitalOcean.

* Скопируйте IP адреса серверов в *ansible/hosts* из вывода Terraform. В каждой группе должно быть по одному хосту. В группе серверов с алиас хоста — `server1`, в группе клиентов — `client1`.

* Выполните подготовку серверов командой *make setup-servers*. Команда выполнит подготовку серверов: установит необходимые модули для докера и отключит фаервол (Для простоты тестирования данной практики - в реальном проекте не отключайте, а настраивайте фаервол. Подробнее это разбиралось в уроке Безопасность).

* Подготовка окружения завершена, теперь необходимо связать клиент Consul с сервером. Агенты Consul будут запускаться внутри Docker контейнеров. Для того чтобы они могли между собой общаться, им необходимо указать IP адреса из приватной подсети. В качестве такой сети будем использовать VPC которая предоставляется Digital Ocean.

* В файле *ansible/group_vars/all.yml* опишите переменную `advertise_ip`, в которой будет храниться IP адрес из предоставляемой VPC. Чтобы это сделать, вам необходимо собрать факты о сервере и отфильтровать IP адреса по верной подсети. Этот IP адрес будет выставлять агент Consul, чтобы его могли найти другие агенты.

* В файле *ansible/common/register_consul_server_ip.yml* опишите задачу, которая зарегистрирует в переменную `consul_server_ip` IP адрес в приватной подсети. Принцип такой же, как и на предыдущем шаге, только данные нужно взять из `consul_server_facts`

* Выполните команду `make setup-consul-server`. Откройте  в браузере *http://<consul_server_ip>:8500*. По этому адресу открывается страница с дашбордом Consul. Убедитесь, что отображается запущенный сервер Consul и других нод нет
* Зайдите по ssh на дроплет с сервером Consul. Выполните `docker exec consul-server consul members` и убедитесь, что запущена одна нода
* Выполните запрос с помощью curl по адресу *http://<consul_server_ip>:8500/v1/catalog/nodes* Убедитесь, что в списке только нода сервера
* Выполните команду `make setup-consul-client`. Команда запустит на втором дроплете Consul, который будет клиентом. Выполните предыдущие действия: посмотрите изменения в дашборде Consul, выполните `consul members` (выполните эту команду в контейнере на сервере и с клиентом), выполните запрос к API сервера Consul.
* Выполните команду `make register-consul-service`. Команда запустит контейнер с приложением, скопирует конфиг и перезапустит контейнер с клиентом Consul. Теперь наше приложение будет доступно в дашборде и по api сервера Consul по адресу *http://<consul_server_ip>:8500/v1/catalog/service/devops*

* В файле *solution* добавьте ссылку на задеплоенное приложение (сервер consul): http://<адрес>

### Подсказки

* IP-адрес, который передаётся для биндинга агента Consul — это строка
