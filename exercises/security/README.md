# Безопасность

Цель этого задания — создать простую изолированную инфраструктуру веб-приложения.
Доступ напрямую к веб-серверам будет запрещен. HTTP доступ предоставляется через балансировщик нагрузки, а ssh — через [сервер-бастион](https://ru.wikipedia.org/wiki/Bastion_host). Сами приложения могут общаться со внешним миром, например чтобы что-то сделать на внешних сервисах. Бастион выступает проводником между инфраструктурой приложения и внешним миром. По сути это обычный сервер с самой минимальной конфигурацией и на нём ничего нет кроме ssh. Чтобы что-то выполнить на веб-серверах, то сперва подключаются к бастиону, а с него на сервера внутри сети.

```text
                          |
                        https
                          |
                          v
                +--------------------+
                |    Load Balancer   |
   +----------------------------------------------------+
   |            |                    |                  |
   |            +--------------------+                  |
   |                     |                              |
   |                     |                              |
   |                    http                +---------+ |
   |                     |                  |         | |
   |                     |                  |         | |
   |                     +-------SSH--------| Bastion |<--------SSH-------
   |                     |                  |         | |
   |                     |                  |         | |
   |                     |                  +---------+ |
   |          +----------+----------+                   |
   |          |                     |                   |
   |          v                     v                   |
   |      +-------+             +-------+               |
   |      |  web  |             |  web  |               |
   |      +---+---+             +---+---+               |
   +----------------------------------------------------+
```

## Ссылки

* [Terraform output](https://www.terraform.io/docs/cli/commands/output.html)
* [Ansible Galaxy — geerlingguy.docker](https://galaxy.ansible.com/)
* [Docker — Managing access tokens](https://docs.docker.com/docker-hub/access-tokens/)
* [Terraform resource — digitalocean_firewall](https://registry.terraform.io/providers/digitalocean/digitalocean/latest/docs/resources/firewall)
* [Terraform resource — digitalocean_vpc](https://registry.terraform.io/providers/digitalocean/digitalocean/latest/docs/resources/vpc)
* [Digital Ocean — VPC](https://docs.digitalocean.com/products/networking/vpc/)
* [Digital Ocean — How to Plan Your Custom VPC Network](https://docs.digitalocean.com/products/networking/vpc/resources/plan-your-network/)

## Задачи

* С помощью Terraform опишите инфраструктуру, которая нарисована на диаграмме. Должны быть выполнены следующие требования:

  * Бастион — дроплет с минимальной конфигурацией.
  * Веб-сервера — дроплеты на которых будет работать приложение. Могут изначально содержать Docker
  * Loadbalancer — принимает запросы по HTTP и HTTPS и перенаправляет запросы на веб-сервера
  * Бастион, балансировщик нагрузки, веб-серверы находятся внутри одной приватной сети (VPC)
  * Внутри приватной сети у фаервола веб-серверов внутри сети открыты все порты на входящие и исходящие соединения, а также по протоколу ICMP
  * Правила работы с исходящими запросами (outbound rule): должна быть открыт доступ по ICMP. Остальные правила настраиваются по необходимости, если они требуются для работы приложения - например 53 порт (DNS), 80, 443 (для скачивания образов, обновлений кеша и тд)
  * На фаерволе бастиона открыт только ICMP и порт для ssh (22)

* Подключитесь по ssh к бастиону и зайди на любой веб-сервер. Для того чтобы использовать приватный ключ на удаленном сервере (для дальнейшего подключения) ssh выполняют с опцией -A (ssh agent forwarding):

  ```sh
  ssh -A username@remote_host
  ```

* Выполните деплой приложения

* Откройте приложение по IP адресу веб-сервера — приложение должно быть недоступно. Доступ по HTTP предоставляется только с балансировщика

* В файле *solution* добавьте ссылку на задеплоенное приложение: http://<адрес>

### Подсказки

Чтобы выполнить деплой через бастион можно подготовить конфигурацию SSH. Использование другого конфига для SSH выполняется следующим образом -

  ```sh
  ssh -F /path/to/config
  ```

  Для того чтобы Ansible использовал дополнительные флаги, используется флаг `ssh-extra-args`. Пример:

  ```sh
  ansible -i hosts webservers -m ping --ssh-extra-args "-F /path/to/file"
  ```

  SSH позволяет проксировать запросы с одного сервера на другой. Таким образом мы можем подключиться к веб-серверам по приватным IP адресам. Пример такой конфигурации и его использования

  ```text
  Host bastion
    Hostname 188.166.54.71 // публичный IP-адрес бастиона
    User root

  Host 192.168.10.3 // IP-адрес полученный из созданной VPC
      ProxyJump bastion
      User root

  Host 192.168.10.4
      ProxyJump bastion
      User root
  ```

  ```sh
  ssh -F /path/to/config 192.168.10.4
  ```
